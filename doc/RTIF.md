# Dynamic Diffuse Global Illumination with Ray-Traced Irradiance Fields

> Citation: Zander Majercik, Jean-Philippe Guertin, Derek Nowrouzezahrai, and Morgan McGuire, Dynamic Diffuse Global Illumination with Ray-Traced Irradiance Fields, Journal of Computer Graphics Techniques (JCGT), vol. 8, no. 2, 1-30, 2019  
> Available online http://jcgt.org/published/0008/02/01/

## 摘要

本文提出了一种高效地计算动态场景地全局光照地方法，我们基于传统地辐射度探针，对场景地辐照场进行压缩编码。
1. 使用一种高效的GPU内存布局、几何光线追踪和合适地采样速率计算动态辐照场。
2. 设计一种稳定地辐照滤波查询，并引入了一种新的基于瞬时可见度感知的插值算法。
3. 本文通过实验探讨了性能和精度的取舍，结果表明本文的关于动态全局光照的方法可适用于各种几何复杂度和光照复杂度的场景（表1）。
为了证明结果的完整性，我们附带了一个使用全动态光场采样的光线追踪展示和相关的GLSL代码

## 1. 介绍

### 基于探针的全局光照：  

使用精确的全局光照（GI）效果合成图像，可显著增强计算机生成的影像的可信性。如何精确地求解基于物理地全局光照方程是一个长期的研究领域，即使是在离线渲染中算是非常耗时的。为了在实时渲染中生成较真实的全局光照效果，人们提出了许多不同的方法来减少光照的计算量。每种方法都在精确度、灵活性和性能表现上做了不同的取舍。

近年来一些关于光场探针的研究就体现了这种取舍。该方法使用静止的经过预计算的辐照探针来表示场景中的静态光场[McGuire et al. 2017b]。这种使用探针的的表示方法有许多优点，例如可以高效和精确地使用光线追踪计算间接反射高光，同时支持类辐射探针查询，以获得更平滑地间接漫发射照明。

通过对光场探针地查询和采样操作，可以以此为基础实现许多着色算法，可以以较高地速率实现高质量地渲染。传统光场探针地主要限制为对场景光照的预计算采样类型及方法。由于探针数据的预计算比较耗时，因此只能处理固定的光源和物体。除此之外，在计算间接光照时，辐照度的空间插值和滤波会产生锯齿和漏光。

### 实时全局光照

与离线渲染不同，像游戏之类的实时程序中的全局光照方法大多依赖于可以根据空间角度获取的光照数据。这些数据一般是预先计算所得，或者仅限于更新频率低的静态几何物体。实现方法主要有光照贴图、辐照探针、场景或光源的体素化等。每种方法都在复杂度、运行灵活性、精确度和消耗上做了不同地取舍。在物体或光照复杂的场景，这些方法都有难以避免的缺陷，最主要的缺陷就是在有许多物体互相遮挡时，由于采样不足和图像重建中的损失，常常发生阴影和光照的泄露。近些年在GDC和SIGGRAPH上有许多关于这些问题的讨论。本文展示了其中两种具有代表性的方法（表2）。

同时，也有多探索性的工作。这些尝试有不同的美术和技术限制。在只考虑静态物体或光照时，常常使用后处理来实现。当然，像这种方法不适用于复杂场景并且仍需要离线预计算。由于动态场景中场景物体和光照会在运行时变化，因此这些方法不适用于动态场景。因此，实时渲染需要一种能适用于动态场景且不牺牲过多性能的全局光照算法。

之前的技术的关键问题是缺少可见性信息，无法对光照场或辐照场进行编码（光照场和辐照场的区别是辐照场将遮蔽考虑在内）。

本文基于传统的辐照探针方法提出了一种新的辐照场表示方法，该方法可以在运行时进行高效地更新。本文也对该方法的性能和质量进行了评估。

### 主要贡献

* 通过增量方案，使用紧凑的 GPU 定制数据布局和计算规划，用准确和动态的遮挡信息扩展辐照度探头，以实现可以"无限"反射的漫反射全局光照。

* 一种光线追踪实现的辐照探针算法，该算法不受分辨率和帧率的影响，避免了对高分辨率球形贴图的降噪和滤波。

* 一种空间插值、遮蔽和滤波的规划算法，可以更好地适用于动态场景地辐照度查询。

* 一种适用于许多情形的对路径追踪结果的快速近似算法。该算法支持带有遮挡的可动态更新辐照信息和基于GPU的光线追踪高光反射，可以有效地减少锯齿。

* 开源的用于实现动态漫反射全局光照的相关shader代码，这些代码应与开源的G3D Innovation Engine[McGuire et al.2017a]一起使用。


## 2. 相关工作

### 基于图像的光照
基于图像的光照方法构成了现代游戏中大多数交互式光照缓存方法的基础[Martin and Einarsson 2010; Ritschel et al. 2009; McAuley 2012; Hooker 2016]。通常，一个常见的工作流都会涉及到场景中光照探针的摆放，每个探针都会构建一张球形辐照贴图，也常常将这些贴图预先进行滤波并保存，来加速运行时的着色计算。

传统光照探针的一个有趣的变体是允许美术人员在场景中放置手动长方体或球形探针代理，这些探针代理可以在访问探针时更好地表现反射的空间变化情况[Lagarde and Zanuttini 2012]。也可以使用自定义的凸多边形代理物体，便于在运行时更好地进行探针查询结果的插值，减少漏光现象。

这些基于探针和图像的光照技术广泛应用于现代的离线渲染和实时渲染，有兴趣的读者可以参考Reinhard等的综合调研报告 [Reinhard et al. 2006]。

虽然基于图像的光照系统可以实现较好的全局光照效果，手动放置探针和探针代理仍然很麻烦[Hooker 2016]。目前，如何不手动调整，探针的位置就容易引起光照和阴影泄漏或影响反射效果。为了避免这个问题，一些引擎使用屏幕空间的光线追踪来获得像素精确的反射效果[Valient 2013]。然而，这些方法无法反射出不在屏幕上的物体，会导致不同视角反射效果不同和光照的不稳定。

### 光场探针

通过将一些附加的场景信息编码进球形探针中，光场探针技术可以将静态场景中的这些问题进行分解[McGuire et al. 2017b]。[Silvennoinen and Lehtinen 2017]提出了一种动态光照算法，但这个方法仅支持粗糙的动态遮挡效果。并且需要复杂的探针摆放位置。本文扩展了[McGuire et al. 2017b]的方法，在保留功能的同时使之可以在运行使处理动态物体和光照变化（第5节），同时无需手动放置探针且没有漏光现象，反射效果也更加近似于世界空间光线追踪算法的效果（第4.2节）。本方法无需手动设置探针代替物体，支持可见性加权混合，权重可根据自动滤波辐射采样来设置（第5节）。因此，光场探针对于传统的辐照度查找表和世界空间光线追踪均可适用。

### 实时光线追踪和着色

为了处理实时渲染中点与点之间的遮挡问题，人们提出了许多方法。Ritschel et al.’s [2008]使用阴影贴图编码场景中点的遮挡信息，并使用虚拟点光源来计算二次漫反射和高光反射，虚拟点光源可以由光线追踪等方法生成。本文的工作受到了另外一种基于体素的锥形光线追踪方法的启发[Crassin et al. ]。一般来说，本文的光线追踪技术可以视为对体素化的场景进行光线追踪（第4.2节），场景的表示类似于用于传统基于体素的锥形光线追踪的八叉树结构。两种方法的主要区别主要有两点：首先，本文的方法首先对辐照深度等场景物体信息进行编码，而不是依赖于八叉树计算局部和整体的可见性；其次，本文方法的空间映射和滤波都不依赖于场景数据。因此本方法可以避免传统体素锥形光线追踪中存在的漏光和阴影泄露问题，同时具有更好的效率和精度。

### 表示方法

本文使用了Cigolle et al.’s [2014]提出的方法，在储存和查询球面分布时，用八面体映射来寻找映射位置。这种方法的的失真较小，且边界管理比立方体映射等方法更为简单。因为本方法的目标是在像素着色器内实现世界空间的光线追踪效果，基于许多之前的对蒙特卡洛积分的实时环境映射方法 [Stachowiak and Uludag 2015; Wyman 2005; Toth et al. 2015; Jendersie et al. 2016]，本方法也可以视为这些方法的一个推广。

[Evangelakos 2015]和[Donow 2016]对单探针的光线追踪准确性和多探针遍历的可行性进行了分析验证，本文也从他们的工作中获得了思路。单个探针可以有效地对具有星形拓扑结构的区域的物体进行采样，因此在这些区域中单探针的光线追踪不会产生可见性错误（除了一些由于探针方向离散化引起的错误）。

## 3. 动态漫反射全局光照探针：概述

按照[McGuire et al. 2017b]提出的方法，本文在场景中一些离散的位置将场景的物体和光照的数据编码进球面贴图。本文使用了一种高效的使用GPU的光线追踪着色算法，并使用滤波过的辐照贴图计算来实时地计算漫反射和镜面反射的间接光照。

本文使用8×8的八面体、GL_R11G11B10格式的贴图来编码球面漫反射辐照度，使用16×16、GL_RG16F格式编码到最近物体的球面距离及平方距离，并将这些贴图打包到一张贴图中，每张贴图的边界处使用对应纹理复制填充，以便于对边界也可以进行双线性插值（表3）。

本方法不是在场景初始化时预计算探针数据，而是动态地根据物体和光照数据更新探针。本文的方法可以生成高质量的动态全局光照，同时保留[McGuire et al. 2017b]方法的高性能。表4中显示了本方法在计算器全范围多次反射的全局光照时的表现。

本方法可以高效地将每一帧的光线追踪结果和探针映射进行混合，并且对探针的深度信息进行插值以适应场景物体的变化。在一个前向或延迟渲染流程中，可以像传统的预计算环境贴图，以间接光缓冲的形式使用探针。

在第4节中，本文讨论了更新动态漫发射全局光照探针的实现细节，随后在第5节中讨论了如何在运行时高效地使用探针来计算动态全局光照。








