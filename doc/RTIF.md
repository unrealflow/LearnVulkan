# Dynamic Diffuse Global Illumination with Ray-Traced Irradiance Fields

> Citation: Zander Majercik, Jean-Philippe Guertin, Derek Nowrouzezahrai, and Morgan McGuire, Dynamic Diffuse Global Illumination with Ray-Traced Irradiance Fields, Journal of Computer Graphics Techniques (JCGT), vol. 8, no. 2, 1-30, 2019  
> Available online http://jcgt.org/published/0008/02/01/

## 摘要

本文提出了一种高效地计算动态场景地全局光照地方法，我们基于传统地辐射度探针，对场景地辐照场进行压缩编码。
1. 使用一种高效的GPU内存布局、几何光线追踪和合适地采样速率计算动态辐照场。
2. 设计一种稳定地辐照滤波查询，并引入了一种新的基于瞬时可见度感知的插值算法。
3. 本文通过实验探讨了性能和精度的取舍，结果表明本文的关于动态全局光照的方法可适用于各种几何复杂度和光照复杂度的场景（表1）。
为了证明结果的完整性，我们附带了一个使用全动态光场采样的光线追踪展示和相关的GLSL代码

## 1. 介绍

### 基于探针的全局光照：  

使用精确的全局光照（GI）效果合成图像，可显著增强计算机生成的影像的可信性。如何精确地求解基于物理地全局光照方程是一个长期的研究领域，即使是在离线渲染中算是非常耗时的。为了在实时渲染中生成较真实的全局光照效果，人们提出了许多不同的方法来减少光照的计算量。每种方法都在精确度、灵活性和性能表现上做了不同的取舍。

近年来一些关于光场探针的研究就体现了这种取舍。该方法使用静止的经过预计算的辐照探针来表示场景中的静态光场[McGuire et al. 2017b]。这种使用探针的的表示方法有许多优点，例如可以高效和精确地使用光线追踪计算间接反射高光，同时支持类辐射探针查询，以获得更平滑地间接漫发射照明。

通过对光场探针地查询和采样操作，可以以此为基础实现许多着色算法，可以以较高地速率实现高质量地渲染。传统光场探针地主要限制为对场景光照的预计算采样类型及方法。由于探针数据的预计算比较耗时，因此只能处理固定的光源和物体。除此之外，在计算间接光照时，辐照度的空间插值和滤波会产生锯齿和漏光。

### 实时全局光照

与离线渲染不同，像游戏之类的实时程序中的全局光照方法大多依赖于可以根据空间角度获取的光照数据。这些数据一般是预先计算所得，或者仅限于更新频率低的静态几何物体。实现方法主要有光照贴图、辐照探针、场景或光源的体素化等。每种方法都在复杂度、运行灵活性、精确度和消耗上做了不同地取舍。在物体或光照复杂的场景，这些方法都有难以避免的缺陷，最主要的缺陷就是在有许多物体互相遮挡时，由于采样不足和图像重建中的损失，常常发生阴影和光照的泄露。近些年在GDC和SIGGRAPH上有许多关于这些问题的讨论。本文展示了其中两种具有代表性的方法（表2）。

同时，也有多探索性的工作。这些尝试有不同的美术和技术限制。在只考虑静态物体或光照时，常常使用后处理来实现。当然，像这种方法不适用于复杂场景并且仍需要离线预计算。由于动态场景中场景物体和光照会在运行时变化，因此这些方法不适用于动态场景。因此，实时渲染需要一种能适用于动态场景且不牺牲过多性能的全局光照算法。

之前的技术的关键问题是缺少可见性信息，无法对光照场或辐照场进行编码（光照场和辐照场的区别是辐照场将遮蔽考虑在内）。

本文基于传统的辐照探针方法提出了一种新的辐照场表示方法，该方法可以在运行时进行高效地更新。本文也对该方法的性能和质量进行了评估。

### 主要贡献

* 通过增量方案，使用紧凑的 GPU 定制数据布局和计算规划，用准确和动态的遮挡信息扩展辐照度探头，以实现可以"无限"反射的全局散射光照。

* 一种光线追踪实现的辐照探针算法，该算法不受分辨率和帧率的影响，避免了对高分辨率球形贴图的降噪和滤波。

* 一种空间插值、遮蔽和滤波的规划算法，可以更好地适用于动态场景地辐照度查询。

* 一种适用于许多情形的对路径追踪结果的快速近似算法。该算法支持带有遮挡的可动态更新辐照信息和基于GPU的光线追踪高光反射，可以有效地减少锯齿。

* 开源的用于实现动态散射全局光照的相关shader代码，这些代码应与开源的G3D Innovation Engine[McGuire et al.2017a]一起使用。


## 2. 相关工作

### 基于图像的光照
基于图像的光照方法构成了现代游戏中大多数交互式光照缓存方法的基础[Martin and Einarsson 2010; Ritschel et al. 2009; McAuley 2012; Hooker 2016]。通常，一个常见的工作流都会涉及到场景中光照探针的摆放，每个探针都会构建一张球形辐照贴图，也常常将这些贴图预先进行滤波并保存，来加速运行时的着色计算。

传统光照探针的一个有趣的变体是允许美术人员在场景中放置手动长方体或球形探针代理，这些探针代理可以在访问探针时更好地表现反射的空间变化情况[Lagarde and Zanuttini 2012]。也可以使用自定义的凸多边形代理物体，便于在运行时更好地进行探针查询结果的插值，减少漏光现象。

这些基于探针和图像的光照技术广泛应用于现代的离线渲染和实时渲染，有兴趣的读者可以参考Reinhard等的综合调研报告 [Reinhard et al. 2006]。

虽然基于图像的光照系统可以实现较好的全局光照效果，手动放置探针和探针代理仍然很麻烦[Hooker 2016]。目前，如何不手动调整，探针的位置就容易引起光照和阴影泄漏或影响反射效果。为了避免这个问题，一些引擎使用屏幕空间的光线追踪来获得像素精确的反射效果[Valient 2013]。然而，这些方法无法反射出不在屏幕上的物体，会导致不同视角反射效果不同和光照的不稳定。

### 光场探针

通过将一些附加的场景信息编码进球形探针中，光场探针技术可以将静态场景中的这些问题进行分解[McGuire et al. 2017b]。[Silvennoinen and Lehtinen 2017]提出了一种动态光照算法，但这个方法仅支持粗糙的动态遮挡效果。并且需要复杂的探针摆放位置。本文扩展了[McGuire et al. 2017b]的方法，在保留功能的同时使之可以在运行使处理动态物体和光照变化（第5节），同时无需手动放置探针且没有漏光现象，反射效果也更加近似于世界空间光线追踪算法的效果（第4.2节）。本方法无需手动设置探针代替物体，支持可见性加权混合，权重可根据自动滤波辐射采样来设置（第5节）。因此，光场探针对于传统的辐照度查找表和世界空间光线追踪均可适用。

### 实时光线追踪和着色

为了处理实时渲染中点与点之间的遮挡问题，人们提出了许多方法。Ritschel et al.’s [2008]使用阴影贴图编码场景中点的遮挡信息，并使用虚拟点光源来计算二次漫反射和高光反射，虚拟点光源可以由光线追踪等方法生成。本文的工作受到了另外一种基于体素的锥形光线追踪方法的启发[Crassin et al. ]。一般来说，本文的光线追踪技术可以视为对体素化的场景进行光线追踪（第4.2节），场景的表示类似于用于传统基于体素的锥形光线追踪的八叉树结构。两种方法的主要区别主要有两点：首先，本文的方法首先对辐照深度等场景物体信息进行编码，而不是依赖于八叉树计算局部和整体的可见性；其次，本文方法的空间映射和滤波都不依赖于场景数据。因此本方法可以避免传统体素锥形光线追踪中存在的漏光和阴影泄露问题，同时具有更好的效率和精度。

### 表示方法

本文使用了Cigolle et al.’s [2014]提出的方法，在储存和查询球面分布时，用八面体映射来寻找映射位置。这种方法的的失真较小，且边界管理比立方体映射等方法更为简单。因为本方法的目标是在像素着色器内实现世界空间的光线追踪效果，基于许多之前的对蒙特卡洛积分的实时环境映射方法 [Stachowiak and Uludag 2015; Wyman 2005; Toth et al. 2015; Jendersie et al. 2016]，本方法也可以视为这些方法的一个推广。

[Evangelakos 2015]和[Donow 2016]对单探针的光线追踪准确性和多探针遍历的可行性进行了分析验证，本文也从他们的工作中获得了思路。单个探针可以有效地对具有星形拓扑结构的区域的物体进行采样，因此在这些区域中单探针的光线追踪不会产生可见性错误（除了一些由于探针方向离散化引起的错误）。

## 3. 动态散射全局光照探针：概述

按照[McGuire et al. 2017b]提出的方法，本文在场景中一些离散的位置将场景的物体和光照的数据编码进球面贴图。本文使用了一种高效的使用GPU的光线追踪着色算法，并使用滤波过的辐照贴图计算来实时地计算漫反射和镜面反射的间接光照。

本文使用8×8的八面体、GL_R11G11B10格式的贴图来编码球面漫辐照度，使用16×16、GL_RG16F格式编码到最近物体的球面距离及平方距离，并将这些贴图打包到一张贴图中，每张贴图的边界处使用对应纹理复制填充，以便于对边界也可以进行双线性插值（表3）。

本方法不是在场景初始化时预计算探针数据，而是动态地根据物体和光照数据更新探针。本文的方法可以生成高质量的动态全局光照，同时保留[McGuire et al. 2017b]方法的高性能。表4中显示了本方法在计算器全范围多次反射的全局光照时的表现。

本方法可以高效地将每一帧的光线追踪结果和探针映射进行混合，并且对探针的深度信息进行插值以适应场景物体的变化。在一个前向或延迟渲染流程中，可以像传统的预计算环境贴图，以间接光缓冲的形式使用探针。

在第4节中，本文讨论了更新动态漫发射全局光照探针的实现细节，随后在第5节中讨论了如何在运行时高效地使用探针来计算动态全局光照。

## 4. 动态漫射全局光照探针的更新

本文在更新探针之前，先将各探针照[McGuire et al. 2017b]中的方法摆放（第4.1节）。在每一帧，按照一定的流程对探针信息进行更新，以将动态的物体和光照信息包括进来。

1. 场景中有m个激活的探针，每个探针生成n条光线并进行光线追踪，并将光线击中的物体表面信息用类似GBuffer的面元缓冲储存起来，分辨率为n×m（第4.2节）。

2. 使用直接光照和间接光照对面元缓冲进行着色（第4.3节），使用相同的流程对最终在摄像机显示的像素进行着色（第5节）。

3. 将n个击中面元的着色、距离、平方距离等信息进行混合，对m个激活探针的八面体表示进行纹理更新（第4.4节）。

本文在4.2节中讨论了几种选择待更新激活探针的方法。本文使用了一种保守的选择方法：将场景中的所有探针均选为激活探针。因此，本方法的渲染性能指标是算法预期性能的保守上限（？）。

本方法在对与探针光线相交的面元进行着色时需要前一帧的探针和光照数据（第4.3节），这种做法可以将计算间接反射的消耗分散到多帧上，也可以对物体边缘等辐照度不连续的位置在时间上进行平滑混合（第4.4节）。当然，这种做法也有缺陷，当视角变化较快时，间接光照由于更新有延时，可能会表现出类似“流动”的效果。与每帧精确更新的直接光照相比较，间接光照会显得更加平滑。根据一些先前的研究和观察工作来看，这些缺陷在观察者的可接受范围内。

### 4.1 探针网格放置

将场景体积划分为轴均匀的网格，将探针放置在网格的各顶点上。每个轴的分辨率应是2的指数，这样可以将探针索引简化为位运算。在不同轴需要不同空间离散度时，每个轴可以单独进行缩放。

在放置探针时，可见度感知探针的选择和采样可以有一定的自由度。落在墙体或其他物体内的探针会被可见度查询忽略掉[McGuire et al. 2017b]。按网格状放置仅仅是为了简化探针索引，因此，探针也可以根据其他计划放置。

空间中的每个点都与与包含该点的网格单元格的八个顶点相对应的顶点框架相关联。通过调整网格分辨率和进行缩放，使每个房间空间中至少有一个完整的顶点保持架，这是为了确保对场景中每个分离/不同的空间内的局部照明变化进行充分的采样。以人的尺度来观察的话，一到两米的网格间距已经比较适合，为了说明结果，本文对不同网格间距进行了测试。

### 4.2 生成光线并进行追踪

首先根据动态物体和光照变化对探针的纹理进行更新，在时间上对结果进行混合，以平滑最终输出图像的动态变化。

类似于[McGuire et al.2017b]，对于m个激活的探针，每个探针都根据随机旋转的斐波那契螺旋序列在球面上确定n个方向。随后每个探针从中心出发，向这些方向发射n条光线进行追踪。探针发出的这些光线应进行合理规划，使之可以并行运行。

由于Vulkan和DirectX的光线追踪API可以从一个基础的shader发射光线，本文对射线批处理进行了基准测试，并观察到这些API通过检查中间状态的着色结果，将寄存器压力降至最低，同时可以便于调试。

本文尝试了几种探针和光线追踪采样的方案，例如：每帧仅更新摄像机一定范围内的探针，或者基于探针到摄像机的距离改变发射光线的数量。虽然这些方案可以获得预期的性能提升，但也引入了许多与场景相关的参数，同时也会消耗额外的空间。

为了简化最终结果，本文的方法将场景中的每个探针都设为激活探针，每一帧对每个探针都进行更新，每个探针也发射相同数量的光线。像大地图开发世界等复杂的使用情形中，可以使用探针流加载或者根据网格尺度对探针进行LOD操作来提升效率（第7.1节）。


### 4.3 次级面元着色

本文使用一个统一的着色模型进行探针的更新和最终着色。需要计算全局光照的情况有两种：一是对m×n个探针采样点面元进行着色时，另外一个是最终输出摄像机图像时。这两种情况都使用相同的着色流程。在一个渲染流程中，使用最新的实时渲染技术计算直接光照；在另一个渲染流程中，使用探针的数据来计算间接光照。第5节中详细讨论了着色流程的细节。这里先聚焦于两种情况的着色计算的细微差别。

本方法的着色流程使用位置、法线、视线方向作为输入，将着色流程从两种渲染情况中抽象出来（第5节）。对于探针光线追踪中的面元着色更新，本文使用光线与物体相交的面元位置、法线和从面元指向探针的方向作为输入。

### 4.4 探针面元更新

在面元着色完成后，对于m×n个面元点，每个点都有一个待更新的像素值，同时采样面元和探针中心的距离也需要实时更新。

本方法通过将当前帧结果与上一帧结果进行混合来对探针纹理进行更新，混合因子为1-a，其中a用来控制更新速率，本文将a设为0.85到0.98之间。本文使用基于瞬时的滤波阴影查询直接计算过滤的辐照度，从而避免对（更高分辨率）辐射图进行暴力预过滤。这种平滑的辐照场会被用于计算漫发射间接光照（第5.2节）。可以有选择的为镜面间接光照设置着色映射图。

技术说明：为了提供运行效率，数据和更新计算需按照一定的布局进行：probe texels operate in (near) lockstep to their neighbors, often operating on the same ray, blending in its result. 这种做法不仅便于GPU读取数据，也便于进行计算。为了确保辐照度正确表示，本文根据余弦分布来更新辐照度和深度贴图[Akenine-Moller et al. 2018]。对于深度缓冲，本文根据余弦平方分布对缓冲进行锐化，忽略余弦平方分布中权重较低（本文中为低于0.001）的纹理像素。

更新过的球面辐照分布会被用于计算视线无关的漫反射效果，为了正确地表示环境中的动态物体和光照，需要对辐照分布再次更新以计算镜面效果。为了深入了解辐照度和使用光探头计算辐照度，请参考[Akenine-Moller et al. 2018 ]。 

## 5. 使用动态全局光照探针进行着色

在计算带有漫反射、镜面反射、高光的全局光照效果后，本文将分别讨论使用这些分量进行着色的过程。本文技术的独创性贡献如下所述，本文提供了源代码作为参考，所以没有过多地探究细节。

### 5.1 直接光照

本文使用支持阴影延时渲染流程来计算点光源和方向光源的直接光照[Thaler 2011; Donnelly and Lauritzen 2006]。

使用间接光照管线来计算区域光源的直接光照。所有的一次反射间接光由直接光照生成（第5.2节），后续的反射光线都从前一条反射光线生成（第5.3节）。考虑到这一点，本文通过在场景中的区域光源预先设定间接照明量，计算区域光源的直接照明。

表5中的最后一行，表示了区域光的计算流程：除了几何体上的直接光照外，场景中的剩余部分的环境光被计算为来自物体上直接光的间接贡献。

用这种方法，可以避免对区域光照的近似计算，但依赖于探针着色技术的稳定性。本文将在后面对该方法进行详细介绍。

### 5.2 漫射间接光照

本文在每个探针上计算球形辐照分布，扩展了最初的可见度感知探针规划[McGuire et al. 2017b]，根据场景中着色位置处的探针来查询漫反射辐照。本文通过空间变化的漫反射表面反照率来调节入射辐照度，以计算反射光的间接漫反射辐射[Akenine-Moller et al. 2018]。

由于探针位置的入射漫辐照没有考虑局部的遮挡因素，本文使用了屏幕空间光遮蔽作为补充[Shanmugam and Arikan 2007]。但在更新面元着色时不考虑局部的遮挡（第4.3节）。忽略次级光照的遮挡的影响比直接光照要小得多。

本文的间接漫射插值和采样技术和[McGuire et al. 2017b]介绍的不同，本文结合了一些光线跟踪和阴影映射文献中的做法，从而提高对于动态物体和光照的鲁棒性。在获得包围着色位置的的八个网格探针顶点的索引后，根据着色点的位置和方向，使用探针数据进行插值（见表6）。

表7传统的辐照度-探针渲染开始，从每个因素说明了各个权重阶段对最终渲染的视觉影响。

    * 本文根据随着法线和探针方向的点积平滑衰减的柔和阈值，将位于着色位置切面背面的探针剔除。

    * 本文考虑人类视觉系统在（相对）低强度照明时对黑暗区域（即光泄漏）的灵敏度，对光照进行加权：根据单调递减曲线轮廓减少极低辐照度值的贡献（即，小于5%的可表示的强度范围）

    * 本文应用均值和方差偏置的 Chebyshev 插值（如方差阴影映射方法中详述）到可见性查询（参见图 7），以便对辐射查询进行适当筛选。

    * 本文使用与阴影法线和探针方向成比例的偏移量对着色位置进行偏移：通过远离可能的阴影边界，提高了基于可见性的插值权重的鲁棒性

    * 然后，本文使用上述权重和偏置因子，根据色度点和探测中心之间的距离执行标准三线插值

这些加权术语中的每一个都使用保守的 epsilon 测试进行适当的约束，以避免在权重正则化时出现数值问题，例如，避免对0进行正则化。

请注意，使用标准辐照度探针进行着色会导致明显的漏光现象，这与一些相关工作中表现出的现象类似（参见图 2），但本文的最终渲染更接近路径追踪结果。

技术说明：先前的工作使用128×128×6的高精度立方体贴图来储存深度信息，但本文使用的附加的加权方法可将其缩减到 16 × 16 中等精度深度值，而不会产生任何数值问题。

### 5.3 全局光照的多重反弹

本文根据先前的发射光辐照缓冲区（类似于 [McGuire et al. 2017b]），以递归、跨帧方式计算间接光照的多个反射光线。这会导致间接光照的滞后，这在静态摄像机查看的静态场景中最为明显，而当视线、光照和或场景物体是动态的时，间接反射光的滞后并不明显。

当优先考虑固定视角和场景时，本文的方法可以很容易地调整为在显示之前合成所有反射结果。第6节中显示了本方法的性能表现，虽然无法将多次反射的消耗分散在多帧上，但本方法仍达到了实时渲染的速率要求。


