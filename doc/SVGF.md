# Spatiotemporal Variance-Guided Filtering: Real-Time Reconstruction for Path-Traced Global Illumination

[Spatiotemporal Variance-Guided Filter, 向实时光线追踪迈进](https://zhuanlan.zhihu.com/p/28288053)

## 摘要
本文介绍了一种在计算全局光照时，用每像素一个采样的图重建出时间稳定的序列图。为了处理这种大噪点的图像输入，本文使用时间积累提高有效采样数量，并根据时间和空间上像素照度的方差进行分层的图像空间小波变换滤波[Dammertz et al. 2010]。这种层次结构可用于在不同尺度上，使用局部照度方差区分噪声和图像细节信息。

基于物理的光照传输，是实时计算机图形学的一个长期目标。虽然现代游戏中已经可以使用有限的光线追踪形式，基于物理的蒙特卡洛全局光照仍无法达到每秒30帧的最低要求。为了在采样数量很少时也可以实现完全动态的实时路径追踪，关键问题是如何从低采样图像中重建出原图像。与之前的实时重建滤波方法相比，本文的方法在时间稳定性提高约10倍，以1080P的分辨率在现代显卡上运行时，每帧仅需10ms。

## 1 介绍

最近几年里，路径追踪[Kajiya 1986]成了电影和视觉特效的主要渲染算法。为了减少蒙特卡洛采样产生的噪点[Zwicker et al.2015]，各种图像滤波和重建方法也不断发展。这些方法可以在每像素几十到几百采样时重建出无噪点的图像。可以确定，随着降噪算法的不断发展，路径追踪全局光照将开始用于实时渲染中。

近几年来各种游戏和电影都在逐步地从光照的经验模型迁移基于物理的着色模型[McAuley and Hill 2016]。由于光栅化管线的经过简化的光传输机制，开发者开始考虑使用光线追踪来获得精确的阴影、反射和全局光照。但光线追踪需要非常大的计算量，每秒钟生成的光线十分有限[Binder and Keller 2016; Wald et al. 2014]，远远达不到各种降噪算法的要求。同时，在要求更高分辨率和刷新率的趋势下，预期每像素仅采样一次才能在实际上可行。在这个前提约束下，本文提出了一种图像滤波重建方法，可以在实时渲染时加快光线追踪的速度。

本文扩展了Dammertz et al.’s [2010]多层次小波变换滤波方法，以从每像素一个采样的图像序列中计算时间上稳定的全局光照。

从低采样的噪点图中重建出原图像是一件非常困难的事。空间上的高频信号与噪点混杂在一起，难以区分。本文的方法根据先前帧的信息来区分当前帧的细节信息和噪点，并且可以以较快的速度运行。本文主要的贡献包括：

* 一种高效的、在时间上稳定的图像重建算法。该算法根据像素在时间尺度和空间尺度上的方差进行滤波，输入图像每像素仅需一个采样。
* 在一个渲染流程中，根据之前几帧的信息计算当前帧的在时间尺度上的方差，并提供给空间滤波流程。
* 基于Dammertz等的工作[Dammertz et al. 2010]，在一个渲染流程中，综合考虑像素在时间尺度上的方差，通过多层次小波变换对输入颜色进行滤波，同时对时间尺度上的方差进行更新。
* 一种新的不使用其他像素信息的边缘停止函数。

本方法虽然不依赖场景参数和具体的光照传输算法，但需要无噪点的几何缓冲。这意味这本方法不支持景深、运动模糊等需要随机可见的效果。但这些效果可以通过后处理技术来近似。

## 2 相关工作

多年来，研究者一直在避开实时全局光照的研究。无论是对于表面渲染还是体积渲染，现有的几种近似方法也都依赖光照传输的预计算和缓存[Kajiya 1986]。一些附加技术也被用于增强光照效果，如环境光遮蔽、屏幕空间反射和软阴影等[Ritschel et al. 2012]。但即使使用了众多的技术，光照也远远无法达到真实的效果。为了在实时渲染中实现真实光照，可以相信，开发者将迟早切换到使用蒙特卡洛光照传输进行渲染。

路径追踪使用随机采样来计算光照传输，这样可以精确地模拟分散效果[Cook et al. 1984]，包括景深、运动模糊、焦散、软阴影及全局光照等。路径追踪在增强真实感的同时将多种效果整合到一个算法之中，减少了编程的复杂度。这种转变已经发生在离线渲染领域[Keller et al. 2015]，并且出现了一大批用于减少随机噪点的滤波算法。Zwicker等[Zwicker et al. 2015]对这些技术进行了调查:

* 蒙特卡洛降噪。通过引入偏差，对每个像素应用多个蒙特卡洛估计器来减少像素间的差异。这些方法的目标是在平滑输出图像时保留边界、表面细节等信息。大多数离线降噪方法使用每像素数十到数百采样的图像作为输入，随后在空间尺度上进行滤波，其计算时间一般以秒或分钟来计算。

* 基于回归的方法[Bitterli et al. 2016; Moon et al.2014, 2015, 2016; Rousselle et al. 2012]能在输入图像的采样数量较多时(>=128)可以得到比较好的结果，而由于对异常值较敏感，对于采样数量较少时，输出结果比较差。此外，由于其计算复杂度高，不适用于实时渲染。

* Munkberg等[Munkberg et al. 2016]提出在纹理空间进行滤波可以有效地重复利用时间和空间上的信息。然而此方法对于大型场景运算量较大，难以运用在实时渲染中。也可以在路径空间进行滤波[Keller et al. 2016]，但这种方法使用了非常耗时的K最邻近搜索算法，且将渲染和滤波算法合在了一起。

* 交互式蒙特卡洛降噪。Durand等[Durand et al. 2005]使用蒙特卡洛采样建立光场，并由对光场的频率分析得到滤波模板。该方法可扩展使用线性剪切滤波器(Egan et al. [2011a; 2011b; 2009])和轴对齐滤波器s(Mehta et al. [2012; 2013; 2014])，来支持软阴影、运动及散焦模糊和间接光照等效果。使用分离式剪切滤波器时，虽然频率分析消耗增大并且一般需要每像素4-16采样的图像输入，但该滤波器可以得到更好的效果[Hasselgren et al. 2015; Munkberg et al. 2014; Vaidyanathan et al. 2015; Yan et al. 2015]。

* 非线性蒙特卡洛降噪。通过使用异常值剔除[Lee and Redner 1990]、平滑能量分布曲线[Rushmeier and Ward 1994]和各向异性扩散[McCool 1999]等方法进行降噪。Tomasi and Manduchi等[Tomasi and Manduchi 1998]提出了一种边缘保留的双边滤波算法，Xu and Pattanaik等[Xu and Pattanaik 2005]将其用于蒙特卡洛降噪。[Eisemann and Durand 2004; Petschnigg et al.2004] 提出了一种变形的交叉双边滤波方法，该方法将每个像素用其周围像素的加权平均代替，每个像素的权值由位置、颜色通过边缘停止函数计算所得。这种方法在降噪时保留了边缘信息，提高了交叉双边滤波的鲁棒性。

* Li et al. [2012], Rousselle et at. [2013], Kalantari et al. [2013], 和 Bauszat et at. [2015a]提出建立滤波器堆，并根据输入图像的方差自动选择滤波器或对滤波器结果进行插值。Kalantari et al. [2015]提出使用一个小型的神经网络来控制交叉双边滤波时每个像素的权值。这些滤波器可适用于低采样的输入图像，但依赖于预处理或平滑误差估计，且无法在实时渲染中运行。

* 时间性滤波。利用多帧时间上信息可以克服空间滤波的缺点，并且在采样率较低时提高时间上的稳定性。Delbracio et al. [2014]在不同帧之间建立光线直方图来减少闪烁，Meyer and Anderson [2006] 对所有帧进行主成分分析(PCA)，丢弃不重要的数据来提高时间稳定性。Zimmer et al. [Zimmer et al. 2015]使用一种路径空间分解的方法进行运动预测，并使用多重缓冲进行降噪。但这些方法需要预先计算的输入图像集。

* 交互式滤波器一般根据运动向量将当前帧的采样位置投射其他帧[Nehab et al. 2007; Walter et al.1999]。在近些年里，由于时间性抗锯齿(TAA)[Karis 2014]的广泛使用，这种再投影方法变得非常流行。TAA的灵感来自于时间分布的超级采样[Yang et al. 2009]，但不同的是TAA根据情形比较当前像素和再投影位置的像素，无需丢弃过期样本。Patney et al. [2016] 通过预测颜色的统计分布改进了TAA的效果。

## 3 重建管线

以下先对本算法的重建管线进行概述，包括光栅化和路径追踪输入及通过成分分离将识别噪声源的方法，还有重建滤波器及后处理步骤。第4节会详细介绍核心的重建算法。

### 路径追踪
路径追踪的结果作为本方法的重建滤波器的输入，本文使用标准的带事件估计的路径追踪方法来生成每像素1次采样的图像。本文的路径追踪器为更好地使用GPU资源进行了合理优化，使用光栅化管线来高效地生成初始光线。光栅化管线也会生成一个无噪点的几何缓冲[Saito and Takahashi 1990]。几何缓冲中包含一些物体表面的附加属性信息，重建滤波器会根据这些信息对图像进行滤波。

本文使用低差异Halton序列[Halton and Smith 1964]对光源进行采样和计算散射方向。本文对Halton序列的一个子集（大小16）进行循环使用，时态滤波器对结果进行混合，早期样本的贡献会随着时间指数下降，在几帧后就变得十分微小。对于路径的第一次散射事件后的非漫射曲面，本文使用路径空间正则化进行处理。正则化实质上增加了二次散射事件中的表面粗糙度，使路径跟踪器能够通过连接到光源来查找间接反弹的贡献，正则化同样适用于高光泽材质。这种做法提升了光传输过程的鲁棒性，使路径贡献更加均匀。本文将路径长度限制为每个路径一个附加散射事件，从而限制了计算成本。因此，计算的光线数量为，一条用于查找间接可见曲面的光线，外加从主命中点和次要命中点连接到光源的两条阴影光线。

本文路径追踪器会分别输出直接光照和间接光照，这样使得滤波器对不同分量分别进行平滑，以更好地对采样数量少的阴影边界进行重建。进行分离处理会增加消耗，但由于这些处理主要使用光栅化管线，可以共用许多繁重的步骤。

### 重建

本文首先使用将直接可见表面的反射颜色从光追图像中解离出来。这样可以避免图像的高频细节被滤波器平滑掉。就是说，本方法从图像分离出辐照度分量进行平滑，并在重建后重新与贴图合成。除了防止平滑掉图像细节，这种做法还可以利用空间上相邻的采样值。对于多层材质，本文则根据采样权重对每一层分别计算。

本文的重建方法主要包括三个步骤：首先，对光追的1个采样的图像进行时间积累，以提升有效采样率；然后，使用时间上增强过的图像来估计局部光照方差，使用计算出的方差进行多层次的a-trous小波滤波。表3说明了大致的流程，在第4节中会对这些步骤的细节进行详细介绍。最后，将滤波器的输出与表面的反射颜色重新合成。

### 后处理

在重建之后，本文仿照许多现代实时渲染器添加了后处理过程。滤波的结果通过色调映射来处理高动态范围。最后，本文添加了时间性抗锯齿流程[Karis 2014]，来增加时间稳定性，以及消除重建滤波器保留的几何边缘锯齿。

## 4 时空滤波
本文的重建滤波器使用每像素一个采样的路径追踪图像和光栅化的几何缓冲作为输入 [Saito and Takahashi 1990]，并使用先前帧重建后的图像。该滤波器会输出一个重建图像和后继帧缓冲。

本文使用的几何缓冲包括深度、物体空间和时间空间的法线、网格ID、使用光栅化流程生成的基本可见性下的屏幕空间运动向量。历史帧缓冲包括时间积累的颜色及先前帧的深度、法线、网格索引。为了提升鲁棒性，我们刻意避免使用特定的场景信息，例如光源位置、形状、及其他场景属性。同时我们也不指定特定的光照传输方式。

表3中显示了滤波管线的主要步骤。第4.1节中描述了时间性采样积累，4.2节中显示了亮度变化的时空估计方法。4.3节中展示了方差引导的小波滤波。第4.4节中提供了一种边缘停止函数来控制滤波权重。

### 4.1 时间性滤波
现在，时间性抗锯齿（TAA）[Karis 2014]在各大游戏中得到广泛使用，同时也可以将其应用于实时路径追踪。然而，基于颜色的时间性滤波对于噪点较多的输入图像会产生较大的偏差。我们受Nehab et al. [2007]及Yang et al. [2009]的启发提出了一种基于几何的时间性滤波，减少了图像的偏差并提高了有效的采样数量。

在TAA中，需要一个与每帧每个颜色采样位置Ci相关的2D运动向量缓冲。这个运动向量缓冲描述了几何物体相对于前一帧的相对运动，并且我们可以根据运动向量缓冲将当前帧的采样位置变换到上一帧屏幕空间的采样位置。通过查询先前帧滤波器生成的历史颜色缓冲，我们可以连续积累在多帧之间的颜色采样。对于每个采样样本Ci我们可以将其采样位置进行再投影，以从历史颜色缓冲中找到对应的采样样本Ci-1，比较两个样本的深度，物体空间的法线和网格IDs来判断两者是否为同一表面。这些一致性测试使用了类似于先前 [Jouppi and Chang 1999; Kerzner and Salvi 2014]提出的片段合并启发式的经验相似性度量。若两个采样样本为同一表面，则采样结果会按照一定的比例进行新旧颜色的混合。
$$ C_i'=\alpha\cdot C_i +(1-\alpha)\cdot C_{i-1}'  $$
式中，$\alpha$控制随时间的衰减程度，需要综合考虑时间稳定性及滞后性来设置。本文设置的$\alpha$值为0.2。我们的运动向量缓冲可处理相机及刚体的移动情况，可通过在历史帧缓冲中附加额外数据来处理一些更复杂的变换情况及一致性检测。

为了提高运动中的图像质量，我们使用一个2 2的双线性滤波来重新采样$C_{i-1}$。模板中每个采样会独立的测试再投影后的深度、法线、网格ID。如果模板各采样中含有与原表面一致的表面，则抛弃不一致的样本，使用模板中所有与原表面一致的采样样本进行计算。若没有与原表面一致的采样样本，则将模板大小扩大到3 3的大小，再次寻找及测试。若仍未找到一致表面，则可认为表面被遮挡，将模板中所有采样放弃，直接使用$C_i'=C_i$。

### 4.2 方差估计

为了对多孔小波滤波模板进行局部调整，我们利用时域累积来估计颜色亮度的逐像素方差，从而有效地检测噪声。关键的思想是，我们的重建应该避免改变小或没有噪声的区域的样本(例如，完全阴影区域)，而过滤更多的稀疏采样及噪声区域。通过分析不同时间的样本，过滤器检测一个特定样本的可靠性。注意，空间计算的方差仅能作为噪音程度的参考:噪音增加了方差，但无噪声区域也可能有较大的方差。

我们用u1和u2来估计每个像素的亮度方差，u1和u2为颜色亮度的第一和第二原始矩。为了收集足够多的样本来进行有意义的估计，我们在时间上累积这些矩，重复使用几何一致性检验。然后我们估计我们的时间方差从积分矩u1'，和u2'，使用简单的公式
$$\sigma_i'^2=\mu_{2_i}'-\mu_{1_i}'^2  $$

相机移动、动画及视口边界都会产生一些问题，这些问题会影响方差估计的质量。我们的时间历史历史是有限的（一般<4帧），我们不是从空间上估计方差$\sigma_i'^2$，而是使用一个7 7的双边滤波器，其各位置的权重由深度、世界空间法线决定。本质上，对于解除遮挡后的几帧，我们的滤波器依赖于方差的空间估计，直到其在时间上积累了足够的数据可以得到一个稳定的估计值。

### 4.3 边缘保留的多孔小波变换

多孔小波变换使用多次迭代进行多层次地滤波，每次迭代使用逐渐增大的采样范围，但采样元素的数量是一个常数。丢弃细节系数可以平滑输入，而边缘停止函数通过限制边界处的过滤范围来保留尖锐的细节。