# Spatiotemporal Variance-Guided Filtering: Real-Time Reconstruction for Path-Traced Global Illumination

[Spatiotemporal Variance-Guided Filter, 向实时光线追踪迈进](https://zhuanlan.zhihu.com/p/28288053)

## 摘要
本文介绍了一种在计算全局光照时，用每像素一个采样的图重建出时间稳定的序列图。为了处理这种大噪点的图像输入，本文使用时间积累提高有效采样数量，并根据时间和空间上像素照度的方差进行分层的图像空间小波变换滤波[Dammertz et al. 2010]。这种层次结构可用于在不同尺度上，使用局部照度方差区分噪声和图像细节信息。

基于物理的光照传输，是实时计算机图形学的一个长期目标。虽然现代游戏中已经可以使用有限的光线追踪形式，基于物理的蒙特卡洛全局光照仍无法达到每秒30帧的最低要求。为了在采样数量很少时也可以实现完全动态的实时路径追踪，关键问题是如何从低采样图像中重建出原图像。与之前的实时重建滤波方法相比，本文的方法在时间稳定性提高约10倍，以1080P的分辨率在现代显卡上运行时，每帧仅需10ms。

## 1 介绍

最近几年里，路径追踪[Kajiya 1986]成了电影和视觉特效的主要渲染算法。为了减少蒙特卡洛采样产生的噪点[Zwicker et al.2015]，各种图像滤波和重建方法也不断发展。这些方法可以在每像素几十到几百采样时重建出无噪点的图像。可以确定，随着降噪算法的不断发展，路径追踪全局光照将开始用于实时渲染中。

近几年来各种游戏和电影都在逐步地从光照的经验模型迁移基于物理的着色模型[McAuley and Hill 2016]。由于光栅化管线的经过简化的光传输机制，开发者开始考虑使用光线追踪来获得精确的阴影、反射和全局光照。但光线追踪需要非常大的计算量，每秒钟生成的光线十分有限[Binder and Keller 2016; Wald et al. 2014]，远远达不到各种降噪算法的要求。同时，在要求更高分辨率和刷新率的趋势下，预期每像素仅采样一次才能在实际上可行。在这个前提约束下，本文提出了一种图像滤波重建方法，可以在实时渲染时加快光线追踪的速度。

本文扩展了Dammertz et al.’s [2010]多层次小波变换滤波方法，以从每像素一个采样的图像序列中计算时间上稳定的全局光照。

从低采样的噪点图中重建出原图像是一件非常困难的事。空间上的高频信号与噪点混杂在一起，难以区分。本文的方法根据先前帧的信息来区分当前帧的细节信息和噪点，并且可以以较快的速度运行。本文主要的贡献包括：

* 一种高效的、在时间上稳定的图像重建算法。该算法根据像素在时间尺度和空间尺度上的方差进行滤波，输入图像每像素仅需一个采样。
* 在一个渲染流程中，根据之前几帧的信息计算当前帧的在时间尺度上的方差，并提供给空间滤波流程。
* 基于Dammertz等的工作[Dammertz et al. 2010]，在一个渲染流程中，综合考虑像素在时间尺度上的方差，通过多层次小波变换对输入颜色进行滤波，同时对时间尺度上的方差进行更新。
* 一种新的不使用其他像素信息的边缘停止函数。

本方法虽然不依赖场景参数和具体的光照传输算法，但需要无噪点的几何缓冲。这意味这本方法不支持景深、运动模糊等需要随机可见的效果。但这些效果可以通过后处理技术来近似。

## 2 相关工作

多年来，研究者一直在避开实时全局光照的研究。无论是对于表面渲染还是体积渲染，现有的几种近似方法也都依赖光照传输的预计算和缓存[Kajiya 1986]。一些附加技术也被用于增强光照效果，如环境光遮蔽、屏幕空间反射和软阴影等[Ritschel et al. 2012]。但即使使用了众多的技术，光照也远远无法达到真实的效果。为了在实时渲染中实现真实光照，可以相信，开发者将迟早切换到使用蒙特卡洛光照传输进行渲染。

路径追踪使用随机采样来计算光照传输，这样可以精确地模拟分散效果[Cook et al. 1984]，包括景深、运动模糊、焦散、软阴影及全局光照等。路径追踪在增强真实感的同时将多种效果整合到一个算法之中，减少了编程的复杂度。这种转变已经发生在离线渲染领域[Keller et al. 2015]，并且出现了一大批用于减少随机噪点的滤波算法。Zwicker等[Zwicker et al. 2015]对这些技术进行了调查:

* 蒙特卡洛降噪。通过引入偏差，对每个像素应用多个蒙特卡洛估计器来减少像素间的差异。这些方法的目标是在平滑输出图像时保留边界、表面细节等信息。大多数离线降噪方法使用每像素数十到数百采样的图像作为输入，随后在空间尺度上进行滤波，其计算时间一般以秒或分钟来计算。

* 基于回归的方法[Bitterli et al. 2016; Moon et al.2014, 2015, 2016; Rousselle et al. 2012]能在输入图像的采样数量较多时(>=128)可以得到比较好的结果，而由于对异常值较敏感，对于采样数量较少时，输出结果比较差。此外，由于其计算复杂度高，不适用于实时渲染。

* Munkberg等[Munkberg et al. 2016]提出在纹理空间进行滤波可以有效地重复利用时间和空间上的信息。然而此方法对于大型场景运算量较大，难以运用在实时渲染中。也可以在路径空间进行滤波[Keller et al. 2016]，但这种方法使用了非常耗时的K最邻近搜索算法，且将渲染和滤波算法合在了一起。

* 交互式蒙特卡洛降噪。Durand等[Durand et al. 2005]使用蒙特卡洛采样建立光场，并由对光场的频率分析得到滤波模板。该方法可扩展使用线性剪切滤波器(Egan et al. [2011a; 2011b; 2009])和轴对齐滤波器s(Mehta et al. [2012; 2013; 2014])，来支持软阴影、运动及散焦模糊和间接光照等效果。使用分离式剪切滤波器时，虽然频率分析消耗增大并且一般需要每像素4-16采样的图像输入，但该滤波器可以得到更好的效果[Hasselgren et al. 2015; Munkberg et al. 2014; Vaidyanathan et al. 2015; Yan et al. 2015]。

* 非线性蒙特卡洛降噪。通过使用异常值剔除[Lee and Redner 1990]、平滑能量分布曲线[Rushmeier and Ward 1994]和各向异性扩散[McCool 1999]等方法进行降噪。Tomasi and Manduchi等[Tomasi and Manduchi 1998]提出了一种边缘保留的双边滤波算法，Xu and Pattanaik等[Xu and Pattanaik 2005]将其用于蒙特卡洛降噪。[Eisemann and Durand 2004; Petschnigg et al.2004] 提出了一种变形的交叉双边滤波方法，该方法将每个像素用其周围像素的加权平均代替，每个像素的权值由位置、颜色通过边缘停止函数计算所得。这种方法在降噪时保留了边缘信息，提高了交叉双边滤波的鲁棒性。

* Li et al. [2012], Rousselle et at. [2013], Kalantari et al. [2013], 和 Bauszat et at. [2015a]提出建立滤波器堆，并根据输入图像的方差自动选择滤波器或对滤波器结果进行插值。Kalantari et al. [2015]提出使用一个小型的神经网络来控制交叉双边滤波时每个像素的权值。这些滤波器可适用于低采样的输入图像，但依赖于预处理或平滑误差估计，且无法在实时渲染中运行。

* 时间性滤波。利用多帧时间上信息可以克服空间滤波的缺点，并且在采样率较低时提高时间上的稳定性。Delbracio et al. [2014]在不同帧之间建立光线直方图来减少闪烁，Meyer and Anderson [2006] 对所有帧进行主成分分析(PCA)，丢弃不重要的数据来提高时间稳定性。Zimmer et al. [Zimmer et al. 2015]使用一种路径空间分解的方法进行运动预测，并使用多重缓冲进行降噪。但这些方法需要预先计算的输入图像集。

* 交互式滤波器一般根据运动向量将当前帧的采样位置投射其他帧[Nehab et al. 2007; Walter et al.1999]。在近些年里，由于时间性抗锯齿(TAA)[Karis 2014]的广泛使用，这种再投影方法变得非常流行。TAA的灵感来自于时间分布的超级采样[Yang et al. 2009]，但不同的是TAA根据情形比较当前像素和再投影位置的像素，无需丢弃过期样本。Patney et al. [2016] 通过预测颜色的统计分布改进了TAA的效果。








