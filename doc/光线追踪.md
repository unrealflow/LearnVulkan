# 光线追踪

## 引言

一个复杂的场景的渲染任务会以物体为单位划分为若干个子任务，每个物体由若干三角面组成，我们将这些三角面经过几何变换映射到屏幕的某些区域，然后将三角面覆盖的区域拆解成一个个的像素，这个拆解的过程就叫做光栅化。

与光栅化渲染不一样的是，光线追踪把一个场景的渲染任务拆分成了从光源或摄像机出发的若干条光线对场景的影响，这些光线彼此不知道对方，但却知道整个场景的信息。每条光线会和场景并行地求交，根据交点位置获取表面的材质、纹理等信息，并结合光源信息计算光照。

## 光线追踪类型

* 前向光线追踪 Forward Ray Tracing：
    前向光线追踪遵循光子从光源到物体。虽然前向光线可以最准确地确定每个物体的颜色，但效率非常低。这是因为来自光源的许多光线永远不会通过视平面并进入眼睛。追踪来自光源的每条光线意味着许多光线将被浪费掉，因为它们从未对从眼睛看。

* 向后光线追踪 Backward Ray Tracing：
    为了使光线追踪更有效，引入了后向光线追踪方法。在后向光线中，在眼睛处产生眼睛光线; 它通过视平面并进入世界。射线击中的第一个物体是从视平面的那个点可见的物体。后向光线的缺点是它假设只有通过视平面并进入眼睛的光线对场景的最终图像有贡献。在某些情况下，这种假设是有缺陷的。

## 加速结构

在光线与场景求交的过程中，如过让每条光线和每个面片都进行求交，则计算量会非常巨大。预先对场景建立加速结构，每条光线根据加速结构进行求交，可以有效减少求交次数。

* 包围盒（Bounding Volumes）：
    层次包围盒算法的基本思想是：用形状简单的包围盒（如球形、长方体等）将场景中的面片包围，相邻的包围盒被包含在一个更大的包围盒里，逐级扩大，生成一个层次的结构；在进行光线与物体相交测试之前先进行光线与包围盒的测试，如果光线与包围盒相交，再与其包含的物体面片进行相交测试，提高效率；通过将包围盒按照有效的层次结构进行组织，减少进行相交测试的数目，降低复杂度，进一步得到效率上的提升。在实际应用中，最常用的是轴对称包围盒（Axis Aligned Bounding Box，AABB）。AABB轴对称包围盒简便，易于存储，易于计算，鲁棒性好，是对相交测试简便性和包围物体紧凑性的较好折中，效率较高。

* 均匀网格：
    空间网格是把三维空间分别沿着三个方向轴以特定宽度划分，得到一定分辨率的网格，场景中的面片都被分配到相应的网格中。每个网格可以含有不同的面片，每个网格保存其所包含的场景面片的引用。最简单的便是均匀网格，把场景进行均匀划分。

* KD-Tree
    BSP树是一种空间分割技术，在许多领域都有所应用，于20世纪90年代被引入到计算机图形学的各个研究领域和应用场合。KDTree可以看作是BSP树的一种特例，它是推广到多维空间下的树形结构。原理是将整个场景作为一个树，通过分割平面将当前树划分为两个空间得到两个子树，这两个子树又分别被各自的分割平面分割得到更小的子树，直到树的深度达到预定的阈值或者节点中含有的场景面片数小于预定的阈值。树的每个节点表示一个子空间，囊括所代表空间中包含的所有面片，树的根节点代表整个景空间。