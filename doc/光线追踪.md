# 光线追踪

## 引言

一个复杂的场景的渲染任务会以物体为单位划分为若干个子任务，每个物体由若干三角面组成，我们将这些三角面经过几何变换映射到屏幕的某些区域，然后将三角面覆盖的区域拆解成一个个的像素，这个拆解的过程就叫做光栅化。

与光栅化渲染不一样的是，光线追踪把一个场景的渲染任务拆分成了从光源或摄像机出发的若干条光线对场景的影响，这些光线彼此不知道对方，但却知道整个场景的信息。每条光线会和场景并行地求交，根据交点位置获取表面的材质、纹理等信息，并结合光源信息计算光照。

## 光线追踪类型

* 前向光线追踪 Forward Ray Tracing：
    前向光线追踪遵循光子从光源到物体。虽然前向光线可以最准确地确定每个物体的颜色，但效率非常低。这是因为来自光源的许多光线永远不会通过视平面并进入眼睛。追踪来自光源的每条光线意味着许多光线将被浪费掉，因为它们从未对从眼睛看。

* 向后光线追踪 Backward Ray Tracing：
    为了使光线追踪更有效，引入了后向光线追踪方法。在后向光线中，在眼睛处产生眼睛光线; 它通过视平面并进入世界。射线击中的第一个物体是从视平面的那个点可见的物体。后向光线的缺点是它假设只有通过视平面并进入眼睛的光线对场景的最终图像有贡献。在某些情况下，这种假设是有缺陷的，难以模拟漫反射辉映、焦散等效果。

如上所述，有效且最容易实现性能优化的一种方法是从眼睛向后发射光线，而不是从光源光发射线。通过这种方式，不会浪费计算能力来从未击中模型或相机的光线。

## 加速结构

在光线与场景求交的过程中，如过让每条光线和每个面片都进行求交，则计算量会非常巨大。预先对场景建立加速结构，每条光线根据加速结构进行求交，可以有效减少求交次数。

* 包围盒（Bounding Volumes）：
    层次包围盒算法的基本思想是：用形状简单的包围盒（如球形、长方体等）将场景中的面片包围，相邻的包围盒被包含在一个更大的包围盒里，逐级扩大，生成一个层次的结构；在进行光线与物体相交测试之前先进行光线与包围盒的测试，如果光线与包围盒相交，再与其包含的物体面片进行相交测试，提高效率；通过将包围盒按照有效的层次结构进行组织，减少进行相交测试的数目，降低复杂度，进一步得到效率上的提升。在实际应用中，最常用的是轴对称包围盒（Axis Aligned Bounding Box，AABB）。AABB轴对称包围盒简便，易于存储，易于计算，鲁棒性好，是对相交测试简便性和包围物体紧凑性的较好折中，效率较高。

* 均匀网格：
    空间网格是把三维空间分别沿着三个方向轴以特定宽度划分，得到一定分辨率的网格，场景中的面片都被分配到相应的网格中。每个网格可以含有不同的面片，每个网格保存其所包含的场景面片的引用。最简单的便是均匀网格，把场景进行均匀划分。

* KD-Tree
    BSP树是一种空间分割技术，在许多领域都有所应用，于20世纪90年代被引入到计算机图形学的各个研究领域和应用场合。KDTree可以看作是BSP树的一种特例，它是推广到多维空间下的树形结构。原理是将整个场景作为一个树，通过分割平面将当前树划分为两个空间得到两个子树，这两个子树又分别被各自的分割平面分割得到更小的子树，直到树的深度达到预定的阈值或者节点中含有的场景面片数小于预定的阈值。树的每个节点表示一个子空间，囊括所代表空间中包含的所有面片，树的根节点代表整个景空间。


## 一般流程

* 从相机进行光线投射，计算屏幕中的每一个像素对应的光线的方向，并找出光线与场景的交点。

* 对于每个光线与场景的交点，根据材质用光源进行着色，同时由交点向光源发射阴影光线，判断该交点是否处于阴影中。

* 为了得到柔和的阴影，在进行着色和发射阴影光线前，根据光源的大小、形状，每次光线追踪使用不同噪声值对光源位置进行偏移，使用偏移后的光源位置来进行计算。

* 在交点着色完成后，根据材质的反射率和透明度等属性，发射反射光线和折射光线。

* 再发射反射光线和折射光线前，可根据表面粗糙度对表面的法线方向添加噪声，再计算反射方向和折射方向。

* 当达到最大递归深度或未击中场景既停止递归。

* 随着时间积累每次光线追踪的结果，使用一些算法进行降噪。

## 图形API的光线追踪支持

在过去的三十年里，几乎所有的游戏都使用光栅化技术来呈现图像。随着GPU性能不断提升，为了追求更精美的画面，各种技术被加入到渲染管线中。更高的市场要求和眼花缭乱的技术大大增加了开发的复杂度，同时各种技术也只能近似的模拟光照效果，无法更进一步提升。

2018年三月，微软宣布为DirectX 12加入光线追踪支持，取名DirectX Raytracing (DXR)，Vulkan也在之后加入了光线追踪扩展VK_NV_ray_tracing。虽然目前不是很成熟，这无疑是图形API历史上少有的大飞跃，对于未来游戏的画质，以及内容创作的过程都会有很深远的影响。

图形API对光线追踪的支持，主要是加入了一个全新的管线专门执行光线追踪的任务。以后让GPU发起任务的方式除了现有的光栅化渲染，和通用计算以外，新加入了一个追踪光线的调用。

如果说传统光栅化的管线是以一个三角形为单元，将三角形变成像素的过程，那光线追踪的管线则是以一跟光线为单元，描述光线的求交和求交后计算的过程。和光栅化线性管线不同的是，光线追踪的管线是可以通过递归的调用TraceRay()来衍生出另一根光线，并且执行另一个管线实例。

和传统光栅化管线一样，光线追踪的管线有固定的逻辑，也有可编程的部分。新管线中固定逻辑部分是对构建加速结构、光线求交、GPU单元的任务分配等过程进行了包装，交给显卡驱动去进行优化。新增的可编程逻辑也就是新加入的5种着色器（Shader）。分别是：Ray Generation, Intersection, Any Hit, Closest Hit, Miss，分别用于处理初始光线生成、自定义求交判定、光线击中、光线未击中等情况的逻辑。

## NVIDIA图灵架构（RTX系列显卡）

图灵上最主要的新特性就是加入了专门用于加速光线追踪的RTCore，用专有的硬件来加速了传统光线追踪算法中的光线在加速结构BVH的遍历，以及光线和三角形的求交测试（Ray Triangle Intersection Test）。因为RTCore，光线追踪在图灵架构上的效率大大提高，再结合不断发展的各种图像重建技术，各种游戏也开始使用实时光线追踪来得到全局光照效果。

## References

* [光线追踪与实时渲染的未来](https://zhuanlan.zhihu.com/p/34851503)

* [一篇光线追踪的入门](https://zhuanlan.zhihu.com/p/41269520)

* [光线追踪](https://zhuanlan.zhihu.com/p/72673165)